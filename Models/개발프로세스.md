### 실제로 Django 이용해서 AI 모델 serving

[TOC]

#### 파일 구조

```
작가 1
작가 2
작가 3

각각의 하나의 django project
```



#### Django 시작하기

1. conda 가상환경 설정 및 활성화

   ```bash
   # 가상환경 생성
   $ conda create -n style_transfer python=3.7.7
   
   # 가상환경 활성화
   $ conda activate style_transfer
   or
   $ source activate style_transfer
   ```

   - 가상환경에서 torch import를 못하는 오류 발생 => pip install 하면 1.1.8+cpu 처럼 cpu 버젼이어서 인식 못하는 문제 발생하는 듯
   - 아나콘다로 가상환경 바꿔보기로(아나콘다는 버젼이 뒤에 +cpu가 붙지 않음)

2. Django & Djangorestframework 설치

   ```bash
   $ pip install django djangorestframework
   ```

3. django project 시작

   ```bash
   $ django-admin startproject [프로젝트 이름]
   ```

4. pytorch dependency 설치

   ```bash
   $ pip install -r requirements.txt
   ```

5. app 설치(모델 올릴 부분)

   ```bash
   $ python manage.py startapp [app name]
   ```

6. settings.py 설정

   ```python
   # settings.py
   
   INSTALLED_APPS = [
   	...
       # restframework
       'rest_framework',
       # app name
       'klimt',
   ]
   ```

7. media, static directory 설정(파일 저장 및 꺼내서 사용하게 설정)

   ```python
   # settings.py
   
   TATIC_URL = '/static/'
   
   # 프로젝트 전반적으로 사용하는 static 파일 경로 지정
   STATICFILES_DIRS = [
       os.path.join(BASE_DIR, 'static'),
   ]
   
   # 배포를 위해(collectstatic) app static들을 모아줄 directory 위치 지정
   STATIC_ROOT = os.path.join(BASE_DIR, 'static')
   
   # 사용자 입력 사진 저장
   MEDIA_URL = '/media/'
   
   # media 파일 저장 경로
   MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
   ```

   STATIC_ROOT

   > 배포 시에(개발 시에는 필요 없음) `collectstatic`명령어를 통해 모든 static 파일들을 복사해서 저장하는 공간

   STATICFILES_DIRS

   > `collectstatic`을 수행할 때 참고하는(즉, static files을 가져오기 위해) 위치들 지정

8. url 지정

   ```python
   # urls.py
   # static - 정적 파일들의 url 관리를 위해 사용
   from django.conf import settings
   from django.conf.urls.static import static
   
   
   urlpatterns = [
       path('admin/', admin.site.urls),
       # api url
       path('predict/klimt/', transfer),
   ] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
   ```



#### AI 모델 연결

*Klimt의 예시*

 1.  사용할 모델들 올리기

     ```
     파일 구조
     klimt(app)
     	style_transfer(model 저장)
     		decoder
     		vgg_normalised
     		function.py
     		net.py
     		test.py
         ...
     ```

     

 2.  csrf 허용 처리

     ```python
     # views.py
     
     # JSON response
     from django.http import HttpResponse, JsonResponse
     # csrf 허용
     from django.views.decorators.csrf import csrf_exempt
     
     
     @csrf_exempt
     def style_transfer(request):
         ...
     ```

	3. parser로 request.data 접근케 형태 설정(django에서 읽을 수 있게)

    ```python
    
    ```

    [DRF parser 참고](https://github.com/django-rest-framework-study/weeklystudy/blob/master/week6/parsers.md)





